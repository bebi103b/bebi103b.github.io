{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Using Google Colab\n",
    "\n",
    "<hr>"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Google Colab provides a convenient, free platform for running Jupyter notebooks in the cloud.\n",
    "\n",
    "In order to use Google Colab, you must have a Google account. Caltech students and employees have an account through Caltech's G Suite. Many of you may have a personal Google account, usually set up for things like GMail, YouTube, etc. For your work in this class, **use your Caltech account.** This will facilitate collaboration with your teammates in the course, as well as with course staff.\n",
    "\n",
    "Many of you probably use your personal Google account on your machine, so it can get annoying to log in and out of it. A trick that I find useful is to use one browser, e.g., Safari or Microsoft Edge, for your personal use, web browsing, etc., and a different browser for your scientific work, including the work in this class. Google Colab are most tested for Chrome, Firefox, and Safari (in fact JupyterLab, which you will use on your own machine, only supports these three browsers).\n",
    "\n",
    "Once you have either logged out of all of your personal accounts or have a different browser open, you can launch a Colab notebook by simply navigating to [https://colab.research.google.com/](https://colab.research.google.com/). Alternatively, you can click the \"Launch in Colab\" badge at the top right of this page, and you will launch this notebook in Colab. That badge will appear in the top right of all pages in the course content generated from notebooks."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "jp-MarkdownHeadingCollapsed": true
   },
   "source": [
    "## Watchouts when using Colab\n",
    "\n",
    "If you do run a notebook in Colab, you are doing your computing on one of Google's computers via a virtual machine. You get two CPU cores and limited (about 12 GB, but it varies) RAM. You can also get GPUs and TPUs (Google's tensor processing units), but we will not use those in this course. The computing resources should be enough for all of our calculations this term, but due to the limitation to two cores and some of the watchouts below, Colab may not be the best platform to use.\n",
    "\n",
    "- If your notebook is idle for too long, you will get disconnected from your notebook. \"Idle\" means that cells are not being edited or executed. The idle timeout varies depending on the load on Google's computers; I find that I almost always get disconnected if idle for an hour.\n",
    "- Your virtual machine will disconnect if it is being used for too long. It typically will only available for 12 hours before disconnecting, though times can vary, again based on load. If you do not efficiently code some of your sampling, the calculations may exceed 12 hours, so this may present a problem.\n",
    "\n",
    "These limitations are in place so that Google can offer Colab for free. If you want more cores, longer timeouts, etc., you might want to check out [Colab Pro](https://colab.research.google.com/signup). However, the free tier should work well for you in the course. You can of course always run on your own machine, and in fact are encouraged to do so.\n",
    "\n",
    "There are additional software-specific watchouts when using Colab.\n",
    "\n",
    "- Colab does not allow for full functionality of [Bokeh](http://bokeh.pydata.org/) apps with Python callbacks.\n",
    "- Colab instances have specific software installed, so you will need to install anything else you need in your notebook. This is not a major burden, and is discussed in the next section.\n",
    "\n",
    "To circumvent these limitations, you may with to upgrade to Colab Pro, which is not free. I recommend reading the [Colab FAQs](https://research.google.com/colaboratory/faq.html) for more information about Colab."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "jp-MarkdownHeadingCollapsed": true
   },
   "source": [
    "## Software in Colab\n",
    "\n",
    "When you launch a Google Colab notebook, much of the software we will use in class is already installed. It is not always the latest version of the software, however. In fact, as of January 2024, Colab is running Python 3.10, whereas you will run Python 3.11 on your machine through your Anaconda installation. Nonetheless, most (but not all) of the analyses we do for this class will work just fine in Colab.\n",
    "\n",
    "Because the notebooks in Colab have software preinstalled, and no more, you will often need to install software before you can run the rest of the code in a notebook. To enable this, when necessary, in the first code cell of each notebook in this class, we will have the following code (or a variant thereof depending on what is needed or if the default installations of Colab change). Running this code will not affect running your notebook on your local machine; the same notebook will work on your local machine or on Colab. Importantly, when using [Stan](http://mc-stan), you will need to install Stan in your Colab session using `cmdstanpy.install_cmdstan()`, which can take some time, usually several minutes.\n",
    "\n",
    "```python\n",
    "# Colab setup ------------------\n",
    "import os, sys, subprocess\n",
    "if \"google.colab\" in sys.modules:\n",
    "    cmd = \"pip install --upgrade iqplot colorcet datashader bebi103 arviz cmdstanpy watermark\"\n",
    "    process = subprocess.Popen(cmd.split(), stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n",
    "    stdout, stderr = process.communicate()\n",
    "    import cmdstanpy; cmdstanpy.install_cmdstan()\n",
    "    data_path = \"https://s3.amazonaws.com/bebi103.caltech.edu/data/\"\n",
    "else:\n",
    "    data_path = \"../data/\"\n",
    "# ------------------------------\n",
    "```\n",
    "\n",
    "The above method works well and ensures that you have the most recent version of CmdStan installed. The drawback is that the installation of CmdStan takes several minutes. As an alternative, if you want to quick installation, you can use pre-built binaries of CmdStan for Colab.\n",
    "\n",
    "```python\n",
    "# Colab setup ------------------\n",
    "import os, shutil, sys, subprocess, urllib.request\n",
    "if \"google.colab\" in sys.modules:\n",
    "    cmd = \"pip install --upgrade iqplot colorcet datashader bebi103 arviz cmdstanpy watermark\"\n",
    "    process = subprocess.Popen(cmd.split(), stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n",
    "    stdout, stderr = process.communicate()\n",
    "    from cmdstanpy.install_cmdstan import latest_version\n",
    "    cmdstan_version = latest_version()\n",
    "    cmdstan_url = f\"https://github.com/stan-dev/cmdstan/releases/download/v{cmdstan_version}/\"\n",
    "    fname = f\"collab-cmdstan-{cmdstan_version}.tgz\"\n",
    "    urllib.request.urlretrieve(cmdstan_url + fname, fname)\n",
    "    shutil.unpack_archive(fname)\n",
    "    os.environ[\"CMDSTAN\"] = f\"./cmdstan-{cmdstan_version}\"\n",
    "    data_path = \"https://s3.amazonaws.com/bebi103.caltech.edu/data/\"\n",
    "else:\n",
    "    data_path = \"../data/\"\n",
    "# ------------------------------\n",
    "```\n",
    "\n",
    "Notebooks will use this faster mode of installing CmdStan.\n",
    "\n",
    "In addition to installing the necessary software on a Colab instance, this also sets the relative path to data sets we will use in the course. When running in Colab, the data set is fetched from cloud storage on [AWS](https://aws.amazon.com). When running on your local machine for homeworks, the path to the data is one directory up from where you are working.\n",
    "\n",
    "In most notebooks, the Colab and data path setup code cells are hidden in the HTML rendering to avoid clutter, but will be present when you download the notebooks."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## A sample calculation\n",
    "\n",
    "To verify that Colab works for you, fire up a Colab instance and run the code below."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Colab setup ------------------\n",
    "import os, shutil, sys, subprocess, urllib.request\n",
    "if \"google.colab\" in sys.modules:\n",
    "    cmd = \"pip install --upgrade iqplot colorcet datashader bebi103 arviz cmdstanpy watermark\"\n",
    "    process = subprocess.Popen(cmd.split(), stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n",
    "    stdout, stderr = process.communicate()\n",
    "    from cmdstanpy.install_cmdstan import latest_version\n",
    "    cmdstan_version = latest_version()\n",
    "    cmdstan_url = f\"https://github.com/stan-dev/cmdstan/releases/download/v{cmdstan_version}/\"\n",
    "    fname = f\"collab-cmdstan-{cmdstan_version}.tgz\"\n",
    "    urllib.request.urlretrieve(cmdstan_url + fname, fname)\n",
    "    shutil.unpack_archive(fname)\n",
    "    os.environ[\"CMDSTAN\"] = f\"./cmdstan-{cmdstan_version}\"\n",
    "    data_path = \"https://s3.amazonaws.com/bebi103.caltech.edu/data/\"\n",
    "else:\n",
    "    data_path = \"../data/\"\n",
    "# ------------------------------\n",
    "\n",
    "import numpy as np\n",
    "\n",
    "import bebi103\n",
    "import cmdstanpy\n",
    "import arviz as az\n",
    "\n",
    "import bokeh.plotting\n",
    "import bokeh.io\n",
    "bokeh.io.output_notebook()\n",
    "\n",
    "schools_data = {\n",
    "    \"J\": 8,\n",
    "    \"y\": [28, 8, -3, 7, -1, 1, 18, 12],\n",
    "    \"sigma\": [15, 10, 16, 11, 9, 11, 10, 18],\n",
    "}\n",
    "\n",
    "schools_code = \"\"\"\n",
    "data {\n",
    "  int<lower=0> J; // number of schools\n",
    "  vector[J] y; // estimated treatment effects\n",
    "  vector<lower=0>[J] sigma; // s.e. of effect estimates\n",
    "}\n",
    "\n",
    "parameters {\n",
    "  real mu;\n",
    "  real<lower=0> tau;\n",
    "  vector[J] eta;\n",
    "}\n",
    "\n",
    "transformed parameters {\n",
    "  vector[J] theta = mu + tau * eta;\n",
    "}\n",
    "\n",
    "model {\n",
    "  eta ~ normal(0, 1);\n",
    "  y ~ normal(theta, sigma);\n",
    "}\n",
    "\"\"\"\n",
    "\n",
    "with open(\"schools_code.stan\", \"w\") as f:\n",
    "    f.write(schools_code)\n",
    "\n",
    "sm = cmdstanpy.CmdStanModel(stan_file=\"schools_code.stan\")\n",
    "samples = sm.sample(data=schools_data, output_dir=\"./\", show_progress=False)\n",
    "samples = az.from_cmdstanpy(samples)\n",
    "bebi103.stan.clean_cmdstan()\n",
    "\n",
    "# Make a plot of samples\n",
    "p = bokeh.plotting.figure(\n",
    "    frame_height=250, frame_width=250, x_axis_label=\"μ\", y_axis_label=\"τ\"\n",
    ")\n",
    "p.circle(\n",
    "    np.ravel(samples.posterior[\"mu\"]), \n",
    "    np.ravel(samples.posterior[\"tau\"]), \n",
    "    alpha=0.1\n",
    ")\n",
    "\n",
    "bokeh.io.show(p)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Computing environment"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Python implementation: CPython\n",
      "Python version       : 3.11.5\n",
      "IPython version      : 8.15.0\n",
      "\n",
      "numpy     : 1.24.3\n",
      "bokeh     : 3.2.1\n",
      "jupyterlab: 4.0.6\n",
      "\n"
     ]
    }
   ],
   "source": [
    "%load_ext watermark\n",
    "%watermark -v -p numpy,bokeh,jupyterlab"
   ]
  }
 ],
 "metadata": {
  "anaconda-cloud": {},
  "jupytext": {
   "target_format": "ipynb,auto:percent"
  },
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
